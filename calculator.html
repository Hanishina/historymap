<!DOCTYPE html>
<html lang="ja">
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,user-scalable=no">
  <title>人口計算機</title>
  <link rel="canonical" href="https://hanishina.github.io/maps/calculator.html"/>
    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZC2WPE0KKJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-ZC2WPE0KKJ');
  </script>

  <link href="historymap.css" rel="stylesheet" type="text/css">
  <link href="./leaflet-sidebar.css" rel="stylesheet"  type="text/css"/>
  <script src="https://kit.fontawesome.com/04cffbc1d1.js" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
  <!-- <script src="./L.Map.Sync.js"></script> -->
  <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
  <script src="./leaflet-sidebar.js"></script>

  <script>
    var map;
    var polygonLayer;
    var lineLayer;
    var clickedObj;


    var selectedFeatures = [];
    selectedFeatures[0] = [];

    var category;
    var year;

    async function getResources(name, year){
      return $.getJSON(name, function(json){
        var features = json.features;
        if (json.name === "line"){

          var mura = features.filter(function(f){return f.properties.TYPE === "村"});
          var ku = features.filter(function(f){return f.properties.TYPE === "区"});
          var sp_ku  = features.filter(function(f){return f.properties.TYPE === "特別区"});
          var gun = features.filter(function(f){return f.properties.TYPE === "郡"});
          var shicho = features.filter(function(f){return f.properties.TYPE === "支庁"});
          var ken = features.filter(function(f){return f.properties.TYPE === "県"});
          var mizu = features.filter(function(f){return f.properties.TYPE === "湖"});
          var umi = features.filter(function(f){return f.properties.TYPE === "海"});
          var features = mura.concat(ku, sp_ku, gun, shicho, ken, mizu, umi);

          if(year === 2020){
            var date = new Date("2020-10-01");
          }else if(year === 2015){
            var date = new Date("2015-10-01");
          }

          features = features.filter(function(f){
            return new Date(f.properties.START) <= date & new Date(f.properties.END) > date
          });


        }


        features.forEach(function(f, i){
          f.properties.uid = i;
        });
        json.features = features
      });
    }

    async function init(){
      var polygon2020Json = await getResources("2020kokusei.geojson", 2020);
      var polygon2015Json = await getResources("2015kokusei.geojson", 2015);
      var line2020Json = await getResources("line.geojson", 2020);
      var line2015Json = await getResources("line.geojson", 2015);

      map = L.map("map", {zoomControl: false});
      map.setView([35, 137], 8);
      map.setMinZoom(5);
      L.control.zoom({position: "bottomright"}).addTo(map);
      map.createPane("base").style.zIndex = 100;
      map.createPane("polygon").style.zindex = 300;

      polygonRedraw(polygon2020Json);
      lineRedraw(line2020Json);
      year = 2020;
      document.getElementById("year").value = 2020;

      var paleMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
          attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>",
          pane: "base"
      });
      var standardMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
          attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>",
          pane: "base"
      });
      var shadeMap = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png', {
          attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>",
          pane: "base",
          opacity: 0.5
      });
      var photo = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
          attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>",
          pane: "base"
      });
      var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: "&copy; <a href='https://www.openstreetmap.org/copyright' target='_blank'>OpenStreetMap</a> contributors",
          pane: "base"
      });

      var blank = L.tileLayer('', {pane:"base"});

      var baseMaps = {
        "淡色地図(地理院地図)": paleMap,
        "標準地図(地理院地図)": standardMap,
        "陰影起伏図": shadeMap,
        "航空写真": photo,
        "OpenStreetMap": osm,
        "背景非表示":blank
      };

      L.control.layers(baseMaps).addTo(map);

      //背景地図一覧(文字列)
      var baseMapNames = {
        "淡色地図(地理院地図)": "paleMap",
        "標準地図(地理院地図)": "standardMap",
        "陰影起伏図": "shadeMap",
        "航空写真": "photo",
        "OpenStreetMap": "osm",
        "背景非表示": "blank"
      }

      map.addLayer(paleMap);

      L.control.scale({imperial: false, maxWidth: 300}).addTo(map);

      var sidebar = L.control.sidebar({container: "sidebar", closeButton: false}).addTo(map);
      sidebar.open("home");

      var selectCategory = document.getElementById("category")
      selectCategory.addEventListener("change", function(e){
        category = e.target.value;
        rewriteSumTable();
      });

      category = "pop";
      selectCategory.value = "pop";

      var selectYear = document.getElementById("year")
      selectYear.addEventListener("change", function(e){
        if(window.confirm("データを変更すると全ての選択がリセットされます。\nデータを変更しますか？")){
          year = e.target.value;
          selectedFeatures[0] = [];
          rewriteSumTable();
          polygonLayer.remove();
          lineLayer.remove();
          switch(e.target.value){
            case "2020":{
              polygonRedraw(polygon2020Json);
              lineRedraw(line2020Json);
              break;
            }
            case "2015":{
              polygonRedraw(polygon2015Json);
              lineRedraw(line2015Json);
              break;
            }
          }
        }else{
          document.getElementById("year").value = year;
        }
      });

    }

    function polygonRedraw(json){
      polygonLayer = L.vectorGrid.slicer(json, {
        vectorTileLayerStyles: {
          sliced:function(properties){
             return {fill: true, fillColor:"#ff0000" ,fillOpacity:0, opacity:0}
          }
        },
        maxZoom: 18,
        interactive: true,
        getFeatureId: function(f){
          return f.properties.uid;
        },
        pane: "polygon"
      }).on("click", clickEvent)
      .on("mouseover", mouseOverEvent);

      polygonLayer.addTo(map);
    }

    function lineRedraw(json){
      lineLayer = L.vectorGrid.slicer(json, {
        vectorTileLayerStyles: {
          sliced: function(properties){
              switch(properties.TYPE){
                case '村': return{color:"#639394"}
                case '区': return{color:"#857944"}
                case '特別区': return{color:"#326333"}
                case '郡': return{color:"#326333"}
                case '支庁': return{color:"#995514"}
                case '県': return{color:"#8a2725"}
                case '湖': return{color:"#5363b5"}
                case '海': return{color:"#223c8a"}
             }
          }
        },
        maxZoom: 18
      });
      lineLayer.addTo(map);
    }

    function clickEvent(obj){

      if(selectedFeatures[0].some(f => f.uid === obj.layer.properties.uid)){
        selectedFeatures[0] = selectedFeatures[0].filter(f => f.uid !== obj.layer.properties.uid);
        polygonLayer.setFeatureStyle(obj.layer.properties.uid, {fill: true, fillColor:"#ff0000" ,fillOpacity:0, opacity:0});
      }else{
        selectedFeatures[0].push({uid: obj.layer.properties.uid, name: obj.layer.properties.NAME, pop: obj.layer.properties.POPULATION, area: obj.layer.properties.AREA, incr: obj.layer.properties.POP_INCREASE});
        polygonLayer.setFeatureStyle(obj.layer.properties.uid, {fill: true, fillColor:"#ff0000" ,fillOpacity:0.3, opacity:0});
      }

      rewriteSumTable();

    }

    function mouseOverEvent(obj){
      document.getElementById('mouse_name').innerHTML = obj.layer.properties.KEN + obj.layer.properties.NAME;
      document.getElementById('mouse_pop').innerHTML = obj.layer.properties.POPULATION;
      document.getElementById('mouse_area').innerHTML = obj.layer.properties.AREA;
      document.getElementById('mouse_dens').innerHTML = (Math.round(obj.layer.properties.POPULATION / obj.layer.properties.AREA *10)/10) || 0;
      document.getElementById('mouse_pop_i').innerHTML = obj.layer.properties.POP_INCREASE;
    }

    function sum(arr, key){
      var popsum = arr.reduce(function(sum, e){
        return sum + e[key];
      },0);
      return popsum
    }

    function reset(){
      if(selectedFeatures[0].length > 0){
        if(window.confirm("全ての選択を解除しますか？")){
          selectedFeatures[0].forEach(function(f){
            polygonLayer.setFeatureStyle(f.uid, {fill: true, fillColor:"#ff0000" ,fillOpacity:0, opacity:0});
          });
          selectedFeatures[0].splice(0);

          rewriteSumTable();
        }
      }
    }

    function rewriteSumTable(){
      document.getElementById('sel_pop').innerHTML = sum(selectedFeatures[0], "pop");
      document.getElementById('sel_area').innerHTML = Math.round(sum(selectedFeatures[0], "area") *100)/100;
      document.getElementById('sel_dens').innerHTML = (Math.round(sum(selectedFeatures[0], "pop") / sum(selectedFeatures[0], "area") *10)/10) || 0;
      document.getElementById('sel_pop_i').innerHTML = sum(selectedFeatures[0], "incr");
      document.getElementById('sel_count').innerHTML = "選択地物数：" + selectedFeatures[0].length;

      var table = document.getElementById('sel_table')
      while (table.rows[1]) {
        table.deleteRow(1);
      }
      selectedFeatures[0].forEach(function(f){
        var row = document.createElement("tr");
        var value;
        switch(category){
          case "pop": value = f.pop;break;
          case "area": value = f.area;break;
          case "pop_i": value = f.incr;break;
          case "dens": value = (Math.round(f.pop / f.area *10)/10) || 0;break;
        }
        row.innerHTML = "<td>" + f.name + "</td><td>" + value + "</td>";
        table.appendChild(row);
      });
    }




  </script>
</head>

<body onload="init()">
  <div class="header">
    <div class="title">市区町村人口計算機</div>
  </div>
  <div>地図上で選択した市区町村の合計人口・合計面積などを算出します。「人口増加数」は前回調査からの人口増加です。</div>

  <div id="map"></div>
  <div>使用データ：<select id="year"><option value="2020">2020年国勢調査速報値</option><option value="2015">2015年国勢調査</option></select></div>

  <div id="sidebar" class="leaflet-sidebar collapsed">
    <!-- Nav tabs -->
    <div class="leaflet-sidebar-tabs">
        <ul role="tablist"> <!-- top aligned tabs -->
            <li><a href="#home" role="tab"><i class="fa fa-bars active"></i></a></li>
        </ul>
    </div>

    <!-- Tab panes -->
    <div class="leaflet-sidebar-content">
        <div class="leaflet-sidebar-pane" id="home">
            <h1 class="leaflet-sidebar-header">
                人口計算機
            </h1>
            <h3>カーソル位置の地物情報</h3>
            <div id="mouse_name" class="current">-</div>
            <table class="current">
              <tr><th>人口(人)</th><td id="mouse_pop"></td><th>面積(㎢)</th><td id="mouse_area"></td></tr>
              <tr><th>人口増加数(人)</th><td id="mouse_pop_i"></td><th>人口密度(人/㎢)</th><td id="mouse_dens"></td></tr>
            </table>
            <hr>
            <h3>選択地物の合計 <input type="button" value="選択をリセット" onclick="reset()"/></h3>
            <table class="sum">
              <tr><th>人口(人)</th><td id="sel_pop">0</td></tr>
              <tr><th>面積(㎢)</th><td id="sel_area">0</td></tr>
              <tr><th>人口増加数(人)</th><td id="sel_pop_i">0</td></tr>
              <tr><th>人口密度(人/㎢)</th><td id="sel_dens">0</td></tr>
            </table>
            <details>
              <summary id="sel_count">選択地物数：0</summary>
                <table id="sel_table" class="selects">
                  <tr><th>地物名</th><th><select id="category"><option value="pop">人口(人)</option><option value="area">面積(㎢)</option><option value="pop_i">人口増加数(人)</option><option value="dens">人口密度(人/㎢)</option></select></th></tr>
                </table>
            </details>
        </div>
    </div>
  </div>

</body>
</html>
